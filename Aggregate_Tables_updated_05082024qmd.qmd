---
title: "Aggregate_tables_new_formats_05082024"
author: "Jing WU"
format: html
editor: visual
---

## The updated Aggregate Tables with the new format fixed with xlsm

Now the updated aggregate tables with Jake's format are implemented and applied for all the reported aggregate tables by site.

This is the first batch of the aggregate tables <https://nih.app.box.com/folder/259384732758>

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
#| echo: false
#| include: false
#| eval: true
# [hide] 
library(data.table) ###to write or read and data management 
library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management https://tidyselect.r-lib.org/reference/faq-external-vector.html
library(dplyr) ###data management some functions are not available in the dplyr masked in the tidyverse
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
#library(sqldf) ##sql
#library(lubridate) ###date time it is already masked in 'tidyverse'
library(ggplot2) ###plots
library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
#library(stringr) ###to work on patterns, charaters
library(plyr)
library(tidyr)
library(tinytex) #for pdf
#library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
#library(summarytools) ##recommended not applied in this R code
library(gmodels) ##recommended but not applied in this R code
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
#library(patchwork)
library(rio)
library(readxl)


box_auth(client_id = client,
         client_secret = secret)
#dir = box_setwd(259384732758)

outputpath <- "~/Documents/Connect_projects/Biospecimen_Feb2022/Jing_projects/Mia_Requests/AggregateTables/Outputs/"
```

the updated aggregated tables each site submitted:

HP: <https://nih.app.box.com/folder/259386008483> file: <https://nih.app.box.com/file/1505217830295?s=407h8r2llaz8fovgydythq6agg6rk6uy>

SF: <https://nih.app.box.com/folder/259383878314> file: <https://nih.app.box.com/file/1524554802988>

MF: <https://nih.app.box.com/folder/259385406649> file: <https://nih.app.box.com/file/1519618538193>

UC: <https://nih.app.box.com/folder/259384455947> file: <https://nih.app.box.com/file/1520595829841>

HFH: <https://nih.app.box.com/folder/259382411754> file: <https://nih.app.box.com/file/1505222110809>

KPNW: <https://nih.app.box.com/folder/259384631615> file: <https://nih.app.box.com/file/1511090284544>

KPCO: <https://nih.app.box.com/folder/259385476163> file: <https://nih.app.box.com/file/1510877346676>

KPHI: <https://nih.app.box.com/folder/259384739537> file: <https://nih.app.box.com/file/1511092808838>

KPGA: <https://nih.app.box.com/folder/259383158062>. File: 1518593346107

names(dt1) \<- c("newcol","race","factor","Active","Passive","ActiveRecruits","AllElligible","InsUnbSES")

```{r}
#| echo: false
#non-KPsites
dir_ls <- c(259386008483,259383878314,259385406649,259384455947,259382411754)

for (i in dir_ls){
  dir =  box_setwd(dir_id = dir[i])
  box_ls(dir_id=dir,limit=100,max=Inf, field=NULL)
}#box_ls function doesn't work well with xlsm files

file_ls <- c(1505217830295,1524554802988,1519618538193,1520595829841,1505222110809,1518593346107,1511090284544,1510877346676,1511092808838)



site <- c("HP","SF","MF","UCh","HFH","KPGA","KPNW","KPCO","KPHI")
dt <- box_read_excel(file_id=1519618538193,sheet="data_entry")
n <- ncol(dt)
dt1 <- dt[c(6:nrow(dt)),c((n-6):n)]

names(dt)[n-5] <- "factor"
row.1st <- as.numeric(rownames(dt)[grepl("Total",dt$factor)])
rows.del = row.1st-1 

names(dt1) <-  c("race","factor","Active","Passive","ActiveRecruits","AllElligible","InsUnbSES")

row.names(dt1)[grepl("Total|Sex|Ethnicity|Insurance|Urbanicity|Socioeconomic",dt1$factor)]

  row_vec <- c(min(as.numeric(row.names(dt1)[grepl("Total",dt1$factor)]))-rows.del, min(as.numeric(row.names(dt1)[grepl("Sex",dt1$factor)]))-rows.del,min(as.numeric(row.names(dt1)[grepl("Ethnicity",dt1$factor)]))-rows.del,min(as.numeric(row.names(dt1)[grepl("Insurance", dt1$factor)]))-rows.del,min(as.numeric(row.names(dt1)[grepl("Urbanicity",dt1$factor)]))-rows.del, min(as.numeric(row.names(dt1)[grepl("Socioeconomic",dt1$factor)]))-rows.del,1+nrow(dt1))
  
    times <- diff(row_vec)
  groups <- c("Overall","Sex","Race","Insurance","Urbanicity","SES")

  newcol <- NULL
  for (m in 1:length(groups)){
  
  vet <- rep(groups[m],each=times[m])
  newcol <- c(newcol,vet)
  
   }
    tmp <- cbind(dt1,newcol)

  

  tmp$Site <- dt[2,2]
  vars<- c("Total","Active","Passive","ActiveRecruits","AllElligible")

  numbers_only <- function(x) {
  ifelse(!grepl("\\D", x), as.numeric(x),NA)}
  
tmp <- tmp  %>%
    mutate(demo_cat = ifelse(!is.na(race) & grepl("Non-Hispanic|Unknown",factor),race,
                        ifelse(!is.na(race) & factor=="Hispanic", "Hispanic/ Latinx",
                               factor))) 
tmp[,c("Active","Passive","ActiveRecruits","AllElligible")] <- sapply(tmp[,c("Active","Passive","ActiveRecruits","AllElligible")],numbers_only)


d2.group <- filter(tmp,!grepl("Total|Sex|Ethnicity|Insurance|Urbanicity|Socioeconomic",factor)) %>% group_by(newcol) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(newcol, .keep_all = TRUE) %>% as_tibble() 
  # %>%  dplyr::rename_with(., ~ paste0(.x,".group"),any_of(vars))

dt2.missing <- as_tibble(dt2.group) %>% select(contains(vars), Site, newcol) %>%
    mutate(across(where(is.numeric), ~ max(.x)-(.x))) %>% 
    mutate(demo_cat=ifelse(newcol=="Overall",newcol,ifelse(newcol %in% c("SES","Urbanicity"),
                            paste0(newcol,".Missing"),paste0(newcol,".Unknown")))) %>% dplyr::rename_with(.,~gsub(".group","",any_of(contains(vars))))
  

dt2 <- bind_rows(tmp,dt2.missing) %>% filter(.,!grepl("Sex|Ethnicity|Insurance|Urbanicity|Socioeconomic",factor)) %>% 
  mutate(Total = as.numeric(Active) + as.numeric(Passive)) %>% 
  group_by(newcol,demo_cat) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(demo_cat, .keep_all = TRUE) %>% as_tibble() 
 

 dt2 <- dt2 %>% group_by(demofactor,demo_cat) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(demo_cat, .keep_all = TRUE) %>% as_tibble() 


dt2 <- as_tibble(dt2) %>% mutate(Verified_percent = round(100 * as.numeric(Total)/max(as.numeric(Total),na.rm=TRUE), 2),
                                 Response.Rate =ifelse(as.numeric(ActiveRecruits) ==0 | is.na(ActiveRecruits),0, round(100 * as.numeric(Total)/as.numeric(ActiveRecruits,na.rm=TRUE),2)),
                                 ActiveRecruit.Pct = paste0(round(100 * as.numeric(ActiveRecruits)/max(as.numeric(ActiveRecruits),na.rm=TRUE), 2), " %"),
                                 AllElligible.pct = paste0(round(100 * as.numeric(AllElligible)/max(as.numeric(AllElligible),na.rm=TRUE), 2), " %")) %>%  select(demofactor,Site, demo_cat,contains(vars),Verified_percent, Response.Rate,ActiveRecruit.Pct,AllElligible.pct) %>% select(demofactor,Site,demo_cat, Total, Active, Passive, Verified_percent, ActiveRecruits, ActiveRecruit.Pct,Response.Rate,AllElligible,AllElligible.pct,factors)


# dt1 <- dt1 <- filter(dt1,!is.na(combo)) %>%
#     mutate(Total = as.numeric(Active) + as.numeric(Passive),
#            demofactor = str_split_i(combo,"_",1),
#            new_group= case_when(factors=="Overall"  ~ "Overall",
#                               factors=="Female"  ~ "Female",
#                               factors== "Male" ~ "Male",
#                               grepl("Other",factors) ~"Sex.Other",
#                               grepl("Unknown|Missing", factors) ~"Sex.Unknown/ Missing",
#                               #newcol=="Sex" & Factor=="Total" ~"Sex.Total",
#                               race =="White" & grepl("Non-Hispanic|Unknown",factors) ~ "White",
#                               grepl("Asian",race) & grepl("Non-Hispanic|Unknown", factors) ~ "Asian/ Middle Eastern",
#                               grepl("Black",race) & grepl("Non-Hispanic|Unknown",factors) ~ "Black/ African-American",
#                               grepl("Hawaiian",race) & grepl("Non-Hispanic|Unknown",factors) ~ "Native Hawaiian/ Other Pacific Islander",
#                               grepl("Native American",race) & grepl("Non-Hispanic|Unknown", factors) ~ "American Indian/ Alaskan Native",
#                               grepl("Other|Multi-racial",race) & grepl("Non-Hispanic|Unknown", factors) ~ "Multi-racial/ Other",
#                               factors=="Hispanic" ~ "Hispanic/ Latinx",
#                               grepl("Unknown",race) & grepl("Non-Hispanic|Unknown",factors) ~ "Race.Unknown",
#                               
#                               grepl("Commercial|Private|Employment|Purchase",factors) & !grepl("Medic", factor) ~ "Private/Commercial",
#                               grepl("Medicare",factors) & !grepl("Medicaid", factors) ~ "Medicare",  
#                               grepl("Medicaid", factors) ~ "Medicaid",
#                               grepl("Tricare|VA|Military", factors) ~ "Military",
#                               grepl("Other|Worker", factors) & !grepl("Public",factors) ~"Other",
#                               grepl("Uninsured", factors) ~ "Uninsured",
#                               grepl("Ins",combo) & grepl("Unknown", factors) ~ "Insurance.Unknown",
#                               newcol=="Insurance" & factor=="Total" ~"Insurance.Total",
#                               grepl("CODE 1", factors) ~ "RUCA Code 1",
#                               grepl("CODE 2", factors) ~ "RUCA Code 2",                                                    
#                               grepl("CODE 3", factors) ~ "RUCA Code 3",
#                               grepl("CODE 4", factors) ~ "RUCA Code 4",                            
#                               grepl("CODE 5", factors) ~ "RUCA Code 5",
#                               grepl("CODE 6", factors) ~ "RUCA Code 6",                            
#                               grepl("CODE 7", factors) ~ "RUCA Code 7",
#                               grepl("CODE 8", factors) ~ "RUCA Code 8",                            
#                               grepl("CODE 9", factors) ~ "RUCA Code 9",
#                               grepl("CODE 10",factors)  ~ "RUCA Code 10",
#                               combo=="Urb_missing" & grepl("Unknown|Missing", factors) ~ "Urbanicity.Unknown", 
#                               #newcol=="Urbanicity" & grepl("Total", factor) ~ "Urbanicity.Total", 
#                               grepl("First",factors) ~ "First Quartile (ADI scores 1-25)",
#                               grepl("scores 26-50", factors) ~ "Second Quartile (ADI scores 26-50)",
#                               grepl("scores 51-75", factors) ~ "Third Quartile (ADI scores 51-75)",
#                               grepl("scores 76-100", factors) ~ "Fourth Quartile (ADI scores 76-100)",
#                               grepl("Unknown|Missing",factors) ~"SES.Unknown/ Missing"
#   ))
#   
  
  dt1.group <- dt1  %>% group_by(demofactor) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(demofactor, .keep_all = TRUE) %>% as_tibble()
```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}

numbers_only <- function(x) {
  ifelse(!grepl("\\D", x), x, ifelse(grepl("\\D", x),NA,NA))}


file_ls <- c(1505217830295,1524554802988,1519618538193,1520595829841,1505222110809,1518593346107,1511090284544,1510877346676,1511092808838)

agg.ls<- list()
dt.ls <- list()

dt_grp.ls <- list()
for (f in c(1:9)){
  file <- file_ls[f]
  dt <- box_read_excel(file_id=file,sheet="data_entry")

  
  n <- ncol(dt)
  names(dt)[n-5] <- "factor"
   row.1st <- as.numeric(rownames(dt)[grepl("Total",dt$factor)])
  rows.del = row.1st-1 
  
  tmp <- dt[c(6:nrow(dt)),c((n-6):n)]
  names(tmp) <-  c("race","factor","Active","Passive","ActiveRecruits","AllElligible","InsUnbSES")
  row.names(tmp)[grepl("Total|Sex|Ethnicity|Insurance|Urbanicity|Socioeconomic",tmp$factor)]

  
  row_vec <- c(min(as.numeric(row.names(tmp)[grepl("Total",tmp$factor)]))-rows.del, min(as.numeric(row.names(tmp)[grepl("Sex",tmp$factor)]))-rows.del,min(as.numeric(row.names(tmp)[grepl("Ethnicity",tmp$factor)]))-rows.del,min(as.numeric(row.names(tmp)[grepl("Insurance", tmp$factor)]))-rows.del,min(as.numeric(row.names(tmp)[grepl("Urbanicity",tmp$factor)]))-rows.del, min(as.numeric(row.names(tmp)[grepl("Socioeconomic",tmp$factor)]))-rows.del,1+nrow(tmp))
  
  times <- diff(row_vec)
  groups <- c("Overall","Sex","Race","Insurance","Urbanicity","SES")

  newcol <- NULL
  for (m in 1:length(groups)){
  
  vet <- rep(groups[m],each=times[m])
  newcol <- c(newcol,vet)
  
   }
    dt1 <- cbind(tmp,newcol)

  
   dt1$Site <- dt[2,n-6]
   dt.ls[[f]] <- dt1
  print(unique(dt1$Site))
  
  vars<- c("Total","Active","Passive","ActiveRecruits","AllElligible")
  

  dt1 <- dt1  %>%
    mutate(#demofactor = str_split_i(combo,"_",1),
           demo_cat = ifelse(!is.na(race) & grepl("Non-Hispanic|Unknown",factor),race,
                        ifelse(!is.na(race) & factor=="Hispanic", "Hispanic/ Latinx",factor)))


dt2 <- filter(dt1,!grepl("Sex|Ethnicity|Insurance|Urbanicity|Socioeconomic",factor)) 
dt2[,c("Active","Passive","ActiveRecruits","AllElligible")] <- sapply(dt2[,c("Active","Passive","ActiveRecruits","AllElligible")],numbers_only)

dt2 <- dt2 %>% mutate(across(contains(vars),~as.numeric(.x))) %>% select(Site,newcol, demo_cat,Active,Passive,ActiveRecruits,AllElligible)
#dt2 <- dt2 %>% mutate(across(contains(vars), ~ replace_na(0)))

#dt2 <- dt2 %>% mutate(Total =ifelse(is.na(Active), as.numeric(Passive), ifelse(is.na(Passive), as.numeric(Active), as.numeric(Active) + as.numeric(Passive))))

 dt2.group <- dt2  %>% group_by(newcol) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(newcol, .keep_all = TRUE) %>% as_tibble()
   # %>% dplyr::rename_with(., ~ paste0(.x,".group"),any_of(vars))

dt2.missing <- as_tibble(dt2.group) %>% select(contains(vars), Site, newcol) %>%
    mutate(across(where(is.numeric), ~ max(.x)-(.x))) %>% 
    mutate(demo_cat=ifelse(newcol=="Overall",newcol,ifelse(newcol %in% c("SES","Urbanicity"), 
                            paste0(newcol,".Missing"),paste0(newcol,".Unknown")))) 
#%>% dplyr::rename_with(.,~gsub(".group","",any_of(contains(vars))))
  
dt2 <- bind_rows(dt2,dt2.missing[which(dt2.missing$newcol!="Overall"),])  %>%  as_tibble()  %>%
  mutate(demo_cat=ifelse(demo_cat %in% c("Unknown","Missing"),paste(newcol,demo_cat,sep="."),demo_cat),
         Total =ifelse(is.na(Active), as.numeric(Passive), ifelse(is.na(Passive), as.numeric(Active), as.numeric(Active) + as.numeric(Passive)))) %>% group_by(newcol,demo_cat) %>% mutate(across(contains(vars),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(demo_cat, .keep_all = TRUE) %>% as_tibble() 
 


 print(dt2.group)



 #tmp2 <- left_join(dt2,dt2.group[,c("newcol","Active.Recruits.group","Catchment.N.group","total.veri.n.group")], by="newcol") 
 
dt2 <- as_tibble(dt2)  %>% mutate(Verified_percent = round(100 * as.numeric(Total)/max(as.numeric(Total),na.rm=TRUE), 2),
                                 Response.Rate =ifelse(as.numeric(ActiveRecruits) ==0 | is.na(ActiveRecruits),0, round(100 * as.numeric(Total)/as.numeric(ActiveRecruits,na.rm=TRUE),2)),
                                 ActiveRecruit.Pct = paste0(round(100 * as.numeric(ActiveRecruits)/max(as.numeric(ActiveRecruits),na.rm=TRUE), 2), " %"),
                                 AllElligible.pct = paste0(round(100 * as.numeric(AllElligible)/max(as.numeric(AllElligible),na.rm=TRUE), 2), " %")) %>%   select(newcol,Site,demo_cat, Total, Active, Passive, Verified_percent, ActiveRecruits, ActiveRecruit.Pct,Response.Rate,AllElligible,AllElligible.pct)

 # tmp2 <- as_tibble(tmp2) %>% 
 #   mutate(Total = total.veri.n,
 #          Active = active.Veri.n,
 #          Passive = passive.Veri.n,
 #          Verified_percent = round(100*total.veri.n/total.veri.n.group,2),    
 #          Activerecruit = Active.Recruits,
 #          ActiveRecruit.Pct = paste0(round(100 * as.numeric(Active.Recruits)/Active.Recruits.group, 1), " %"),
 #          Response.Rate =ifelse(as.numeric(Active.Recruits) ==0 | is.na(Active.Recruits),0, paste0(round(100 * as.numeric(total.veri.n)/as.numeric(Active.Recruits,na.rm=TRUE),1), " %")),
 #          'All eligible' = Catchment.N,
 #          AllElligible.pct = paste0(round(100 * as.numeric(Catchment.N)/Catchment.N.group, 1), " %")) %>% select(newcol,Site, new_group,Total, Active,Passive,Verified_percent, Activerecruit,ActiveRecruit.Pct, Response.Rate,'All eligible',AllElligible.pct#ResponseRt.Disparity,response.rate.Total
 #                      )
 # 


names(dt2)[3:12] <- c("Demographic Factors", "Total Verified","Active","Passive", "% of Verified", "Active Recruits", "% of Active Recruits","Response Ratio","Eligible Catchment Population","% Eligible")
agg.ls[[f]] <- dt2

#write.csv(dt2,file=paste(outputpath,unique(dt2$Site),"_Aggregate_TableApr302024_integrated_estimatedNpt_",Sys.Date(),".csv",sep=""),row.names = F,quote = F,na="")

}

write.csv(agg.ls[[3]],file=paste(outputpath,"MFH_Aggregate_TableApr302024_integrated_estimatedNpt_",Sys.Date(),".csv",sep=""),row.names = F,quote = F,na="")

#to get the overall aggregate table
vars4 <- c("Total Verified","Active","Passive", "Active Recruits", "Eligible Catchment Population")

All.aggregate <- rbindlist(agg.ls) %>% 
    select(newcol,Site,`Demographic Factors`, `Total Verified`,Active, Passive,`Active Recruits`,`Eligible Catchment Population`) %>% group_by(newcol,`Demographic Factors`) %>%
    mutate(across(contains(vars4),~sum(as.numeric(.x),na.rm=TRUE))) %>% distinct(newcol, .keep_all = TRUE) %>% as_tibble() %>% 
    mutate(Site="Overall",
           `% of Verified` = round(100 * as.numeric(`Total Verified`)/max(as.numeric(`Total Verified`),na.rm=TRUE), 2),
           Response.Rate =ifelse(as.numeric(`Active Recruits`) ==0 | is.na(`Active Recruits`),0, round(100 * as.numeric(`Total Verified`)/as.numeric(`Active Recruits`,na.rm=TRUE),2)),
           `% of Active Recruits` = paste0(round(100 * as.numeric(`Active Recruits`)/max(as.numeric(`Active Recruits`),na.rm=TRUE), 2), " %"),
           `% Eligible` = paste0(round(100 * as.numeric(`Eligible Catchment Population`)/max(as.numeric(`Eligible Catchment Population`),na.rm=TRUE), 2), " %")) %>%   select(newcol,Site,`Demographic Factors`, `Total Verified`,Active, Passive, `% of Verified`, `Active Recruits`, `% of Active Recruits`,Response.Rate,`Eligible Catchment Population`,`% Eligible`)

write.csv(All.aggregate,file=paste(outputpath,"OverAll_Aggregate_TableApr302024_integrated_estimatedNpt_",Sys.Date(),".csv",sep=""),row.names = F,quote = F,na="")

```

Age group extracted from Connect participants rtable

```{r}
bq_auth()
   project <- "nih-nci-dceg-connect-prod-6d04"
  billing <- "nih-nci-dceg-connect-prod-6d04" ##project and billing should be consistent
  
 con <- dbConnect(
   bigrquery::bigquery(),
   project = project,
   dataset = "FlatConnect",
   billing = billing
 )
 
recr_age <- tbl(con,"participants_JP")  %>%  
  filter(.,(!is.na(d_827220437) & ((d_512820379 =='486306141' & d_821247024 != '922622075') | d_512820379 =='854703046' ))) %>% 
  dplyr::select(token,Connect_ID,d_827220437,d_471593703,d_512820379,d_914594314,d_821247024,state_d_934298480) %>% 
  as_tibble() %>%
  mutate(age = case_when(state_d_934298480 == '722846087' ~ "66-70",
                         state_d_934298480 == '124276120' ~ "40-45",
                         state_d_934298480 == '450985724' ~ "46-50",
                         state_d_934298480 == '363147933' ~ "51-55",
                         state_d_934298480 == '636706443' ~ "56-60",
                         state_d_934298480 == '771230670' ~ "61-65",
                         state_d_934298480 == '713781738'~ "30-34",
                         state_d_934298480 == '631272782' ~ "35-39"),
         recruit_type = case_when(d_512820379 == '486306141' ~ "Active",
                                  d_512820379 == '854703046' ~ "Passive",
                                  d_512820379 == '180583933' & d_821247024 == '197316935' ~ "Not Active But Verified"),
        
         verified = case_when(d_821247024 == '875007964' ~ "Not yet verified",
                                             d_821247024 == '197316935'  ~ "Verified",
                                             d_821247024 ==  '219863910' ~ "Cannot be verified",
                                             d_821247024 ==  '922622075' ~ "Duplicate",
                                             d_821247024 ==  '160161595' ~ "Outreach timed out"),                          
         recru_time = ymd_hms(ifelse(d_471593703 =="NA",d_914594314, d_471593703)),
         verified_time = ymd_hms(d_914594314),
         recrstart.date = as.Date(min(ymd_hms(d_471593703),na.rm=TRUE)),
         recruit.week = ceiling(as.numeric(difftime(as.Date(ymd_hms(d_471593703)), as.Date(min(ymd_hms(d_471593703),na.rm=TRUE)),units="days"))/7),
         recrstart.Sunday = as.Date(ifelse(wday(as.Date(min(ymd_hms(d_471593703),na.rm=TRUE))) == 1, as.Date(min(ymd_hms(d_471593703),na.rm=TRUE)),
         as.Date(as.Date(min(ymd_hms(d_471593703),na.rm=TRUE))-wday(as.Date(min(ymd_hms(d_471593703),na.rm=TRUE))) +1 ))),
         Site = case_when(d_827220437 == '531629870' ~ "HealthPartners",
                          d_827220437 == '548392715' ~ "Henry Ford Health System", 
                          d_827220437 == '303349821' ~ "Marshfield Clinic Health System",
                          d_827220437 == '657167265' ~ "Sanford Health", 
                          d_827220437 == '809703864' ~ "University of Chicago Medicine",
                          d_827220437 == '125001209' ~ "Kaiser Permanente Colorado",
                          d_827220437 == '327912200' ~ "Kaiser Permanente Georgia",
                          d_827220437 == '452412599' ~ "Kaiser Permanente Northwest",  
                          d_827220437 == '300267574' ~ "Kaiser Permanente Hawaii"),
         
         Site = factor(Site, levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                                      "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                      "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest")))

recr_age$Week.Sunday <-  ceiling(as.numeric(difftime(as.Date(ymd_hms(recr_age$d_471593703)), as.Date(recr_age$recrstart.Sunday),units="days"))/7)      
recr_age$Week.Sunday.date <-  recr_age$recrstart.Sunday  + dweeks(recr_age$Week.Sunday)   #to set up the end of observation day of a week  
recr_age <-recr_age %>% mutate(Site = case_when(d_827220437 == '531629870' ~ "HealthPartners",
                          d_827220437 == '548392715' ~ "Henry Ford Health System", 
                          d_827220437 == '303349821' ~ "Marshfield Clinic Health System",
                          d_827220437 == '657167265' ~ "Sanford Health", 
                          d_827220437 == '809703864' ~ "University of Chicago Medicine",
                          d_827220437 == '125001209' ~ "Kaiser Permanente Colorado",
                          d_827220437 == '327912200' ~ "Kaiser Permanente Georgia",
                          d_827220437 == '452412599' ~ "Kaiser Permanente Northwest",  
                          d_827220437 == '300267574' ~ "Kaiser Permanente Hawaii"),
         
         Site = factor(Site, levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                                      "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                      "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest")))

recrstart.Sunday <- unique(as.Date(recr_age$recrstart.Sunday))
recrstart.date <-  as.Date(min(as.POSIXct(recr_age$d_471593703),na.rm=TRUE))

recr_age$verified.week <- ceiling(as.numeric(difftime(as_date(recr_age$verified_time),as_date(recr_age$recrstart.date),units="days"))/7)
recr_age$verified.week.date <- (recr_age$recrstart.date) + dweeks(recr_age$verified.week)
recr_age$Verified.Sunday <-  ceiling(as.numeric(difftime(as_date(as.POSIXct(recr_age$verified_time)), as_date(recr_age$recrstart.Sunday),units="days"))/7)      
recr_age$Verified.Sunday.date <-  recr_age$recrstart.Sunday  + dweeks(recr_age$Verified.Sunday)    

###to create the time censoring variables by week;
recruit.wk.active <- recr_age[which(recr_age$d_512820379==486306141),] %>% 
     group_by(Week.Sunday,Week.Sunday.date,age) %>%
     dplyr::summarize(active_recruits=n())

recruit.wk.active.age <- recruit.wk.active %>% pivot_wider(names_from = age, values_from = active_recruits, values_fill = 0)

colnames(recruit.wk.active.age)[3:8] <- paste("Active.Recruits",names(recruit.wk.active.age)[3:8],sep="_")
recruit.wk.active.age <- recruit.wk.active.age %>% mutate()

verified.wk.active <- recr_age[which(recr_age$d_821247024 == 197316935 & recr_age$d_512820379==486306141),] %>% 
  group_by(Verified.Sunday,Verified.Sunday.date,age) %>%
  dplyr::summarize(active_verifieds=n())

verified.wk.total <- recr_age[which(recr_age$d_821247024 == 197316935),] %>% 
  group_by(Verified.Sunday,Verified.Sunday.date,age) %>%
  dplyr::summarize(total_verifieds=n())

verified.wk.all <- merge(verified.wk.active,verified.wk.total, by.x=c("Verified.Sunday","Verified.Sunday.date","age"), 
                         by.y = c("Verified.Sunday","Verified.Sunday.date","age"), all.y=TRUE)
#verified.wk.all$Verified.Sunday.date[is.na(verified.wk.all$Verified.Sunday.date)]<- recrstart.date + verified.wk.all$verified.week*7
recrui_wk_verified <- merge(recruit.wk.active,verified.wk.all, by.x=c("Week.Sunday","age"),by.y=c("Verified.Sunday","age"),all.x=TRUE,all.y=TRUE)
recrui_wk_verified$Week.Sunday.date <- as_date(ifelse(is.na(recrui_wk_verified$Week.Sunday.date),recrui_wk_verified$Verified.Sunday.date,recrui_wk_verified$Week.Sunday.date), origin = lubridate::origin)

recrui_wk_verified <- recrui_wk_verified %>% 
  mutate(Verified.Sunday.date = as_date(ifelse(is.na(Verified.Sunday.date), Week.Sunday.date,Verified.Sunday.date))) %>% 
  mutate_at(c("active_recruits","active_verifieds","total_verifieds"),~replace_na(., 0)) 

#recrui_wk_verified <- recrui_wk_verified %>% mutate(week.date=as_date(do.call(pmax, c(select(.,ends_with('max')),na.rm=TRUE))))

recrui_wk_verified <- recrui_wk_verified %>% arrange(Week.Sunday,Week.Sunday.date,age)

# passive recruits are the passive verified
recrui_wk_verified$passive_verifieds <- recrui_wk_verified$total_verifieds-recrui_wk_verified$active_verifieds #new passive recruitment
recrui_wk_verified$active_recruits.cum <- cumsum(recrui_wk_verified$active_recruits)
recrui_wk_verified$passive_verifieds.cum <- cumsum(recrui_wk_verified$passive_verifieds)
recrui_wk_verified$active_verifieds.cum <- cumsum(recrui_wk_verified$active_verifieds)

recrui_wk_verified$total_recruits <- recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verifieds ##the total recruits till that week

recrui_wk_verified$total_recruits.cum <- cumsum(recrui_wk_verified$active_recruits + recrui_wk_verified$passive_verifieds) ##the total recruits till that week

recrui_wk_verified$total_verified.cum <- cumsum(recrui_wk_verified$total_verifieds)

##by site
site <- levels(factor(recr_age$Site))
verified.site <- list()
recru.verified.site <- list()
for (i in 1:9){
 s <- site[[i]] 
 
recruit.wk.active.sub <- recr_age[which(recr_age$d_512820379==486306141 & recr_age$Site == s),] %>% 
     group_by(Site,Week.Sunday,Week.Sunday.date,age) %>%
     dplyr::summarize(active_recruits=n())

verified.wk.active.sub <- recr_age %>% filter(d_821247024 == 197316935 & d_512820379==486306141 & Site==s) %>% 
  group_by(Verified.Sunday,Verified.Sunday.date,age) %>%
  dplyr::summarize(active_verifieds=n())

verified.wk.total.sub <- recr_age %>% filter(d_821247024 == 197316935 & Site == s)  %>% 
  group_by(Verified.Sunday,Verified.Sunday.date,age) %>%
  dplyr::summarize(total_verifieds=n())

verified.wk.all.sub <- merge(verified.wk.active.sub,verified.wk.total.sub, by.x=c("Verified.Sunday","Verified.Sunday.date","age"), 
                         by.y = c("Verified.Sunday","Verified.Sunday.date","age"), all.y=TRUE)


  verified.site[[i]] <- verified.wk.all.sub
  
recrui_wk_verified.sub <- merge(recruit.wk.active.sub,verified.wk.all.sub, by.x=c("Week.Sunday","age"),by.y=c("Verified.Sunday","age"),all.x=TRUE,all.y=TRUE)

recrui_wk_verified.sub$Week.Sunday.date <- as_date(ifelse(is.na(recrui_wk_verified.sub$Week.Sunday.date),recrui_wk_verified.sub$Verified.Sunday.date,recrui_wk_verified.sub$Week.Sunday.date), origin = lubridate::origin) 

recrui_wk_verified.sub <- recrui_wk_verified.sub %>% 
  mutate(Verified.Sunday.date = as_date(ifelse(is.na(Verified.Sunday.date), Week.Sunday.date,Verified.Sunday.date))) %>% 
  mutate_at(c("active_recruits","active_verifieds","total_verifieds"),~replace_na(., 0)) 

  recru.verified.site[[i]] <- recrui_wk_verified.sub
}

verified.wk.all.sub
recrui_wk_verified.sub.cum <- recru.verified.site[[1]] %>% group_by(age) %>% mutate_at(c("active_recruits","active_verifieds","total_verifieds"),~cumsum(.))

#the last week of Jan. 2024, the total verified #/ active recruits are still smaller than the ones shown in the aggregate tables of overall sites:

table(recr_age[which(recr_age$d_512820379==486306141 & recr_age$recru_time < '2024-02-01'),]$age)


#by site:
#HP:
age_hp <- recr_age[which((recr_age$recru_time < '2024-05-02' | recr_age$verified_time < '2024-05-02') & recr_age$d_827220437 == '531629870' & recr_age$d_512820379=='486306141'),] %>% select(Site, d_827220437, d_512820379,d_821247024) %>% group_by(age)

table(recr_age[which(recr_age$recru_time < '2024-05-02' & recr_age$d_827220437 == '531629870' & recr_age$d_512820379=='486306141'),]$age)

#30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
# 1126  1070 15598 14464 14996 14468 13260  2551 
table(recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '531629870'),]$age,recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '531629870'),]$verified )
  #      
  #       Cannot be verified Duplicate Outreach timed out Verified
  # 30-34                  0         0                  0       40
  # 35-39                  0         0                  0       33
  # 40-45                  1         0                  5      939
  # 46-50                  2         0                  3      850
  # 51-55                  0         0                  2     1022
  # 56-60                  0         0                  0     1007
  # 61-65                  0         0                  0     1112
  # 66-70                  0         0                  0      172
table(recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '531629870' & recr_age$d_512820379=='486306141'),]$age,recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '531629870' & recr_age$d_512820379=='486306141'),]$verified )
       
#        Cannot be verified Outreach timed out Verified
  # 30-34                  0                  0       40
  # 35-39                  0                  0       32
  # 40-45                  1                  5      930
  # 46-50                  2                  3      843
  # 51-55                  0                  2     1011
  # 56-60                  0                  0      993
  # 61-65                  0                  0     1105
  # 66-70                  0                  0      168

#SP
age_sp <- recr_age[which(recr_age$recru_time < '2024-04-9' & recr_age$d_827220437 == '657167265' & recr_age$d_512820379=='486306141'),]
table(recr_age[which(recr_age$recru_time < '2024-04-9' & recr_age$d_827220437 == '657167265' & recr_age$d_512820379=='486306141'),]$age)

#30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
# 1105   869 14809  9471  8977  8742  8607   492 
table(recr_age[which(recr_age$verified_time < '2024-04-09' & recr_age$d_827220437 == '657167265' & recr_age$d_512820379=='486306141'),]$age,recr_age[which(recr_age$verified_time < '2024-04-09' & recr_age$d_827220437 == '657167265'& recr_age$d_512820379=='486306141'),]$verified )
       
#        Outreach timed out Verified
  # 30-34                  0       15
  # 35-39                  0       12
  # 40-45                  1      464
  # 46-50                  0      273
  # 51-55                  0      314
  # 56-60                  0      271
  # 61-65                  0      266
  # 66-70                  0       11

table(recr_age[which(recr_age$verified_time < '2024-04-09' & recr_age$d_827220437 == '657167265'),]$age,recr_age[which(recr_age$verified_time < '2024-04-09' & recr_age$d_827220437 == '657167265'),]$verified )
       
  #       Cannot be verified Duplicate Outreach timed out Verified
  # 30-34                  0         0                  0       15
  # 35-39                  0         0                  0       12
  # 40-45                  3         6                  1      483
  # 46-50                  0         6                  0      283
  # 51-55                  2         5                  0      334
  # 56-60                  0         8                  0      281
  # 61-65                  0         8                  0      278
  # 66-70                  0         0                  0       11

#UCH:
age_uch <-recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864' & recr_age$d_821247024=='197316935'),]

table(tmp$d_512820379)
# 486306141 854703046 
#      3405       963 
table(recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '809703864' & recr_age$d_512820379=='486306141'),]$age)

# 30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
# 13013 12216 60791 43253 43794 39635 37587 10987 
 table(recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864'& recr_age$d_512820379=='486306141'),]$age,recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864'& recr_age$d_512820379=='486306141'),]$verified )
       
  #       Cannot be verified Outreach timed out Verified
  # 30-34                  0                  0      174
  # 35-39                  0                  1      186
  # 40-45                  4                  0      688
  # 46-50                  4                  0      492
  # 51-55                  2                  0      549
  # 56-60                  2                  0      599
  # 61-65                  1                  0      557
  # 66-70                  0                  0      160
 
table(recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864'),]$age,recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864'),]$verified )
  #       Cannot be verified Duplicate Outreach timed out Verified
  # 30-34                  0         0                  0      186
  # 35-39                  0         0                  1      205
  # 40-45                  4         0                  0      814
  # 46-50                  4         0                  0      621
  # 51-55                  3         1                  0      752
  # 56-60                  3         2                  0      837
  # 61-65                  2         2                  0      780
  # 66-70                  2         0                  0      172 

#MFH
age_mf <- recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '303349821'),]

table(recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '303349821'),]$age,recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '303349821'),]$d_512820379)
       
  #       486306141 854703046
  # 30-34       591         5
  # 35-39       587         1
  # 40-45      7670        38
  # 46-50      7547        20
  # 51-55      7574        18
  # 56-60      7699        27
  # 61-65      8317        28
  # 66-70       595         4

table(recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '303349821'),]$age,recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '303349821'),]$verified )
       
#        Cannot be verified Duplicate Verified
#  30-34                  0         0       12
#  35-39                  0         0       20
#  40-45                  0         0      456
#  46-50                  0         0      442
#  51-55                  0         0      428
#  56-60                  0         0      498
#  61-65                  1         0      570
#  66-70                  0         0       39

#HFH
age_hfh <- recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]

table(recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]$d_512820379)
# 486306141 854703046 
#      3536       127 
 table(recr_age[which(recr_age$recru_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]$d_512820379)
# 486306141 854703046 
#     96249       885 
 
 table(recr_age[which(recr_age$recru_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]$age,recr_age[which(recr_age$recru_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]$d_512820379)
  #      
  #       486306141 854703046
  # 30-34      3890         7
  # 35-39      3571         7
  # 40-45     14746        16
  # 46-50     14441         9
  # 51-55     17820         4
  # 56-60     18245        22
  # 61-65     17851        18
  # 66-70      5685         1
table(recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'& recr_age$d_512820379=='486306141'),]$age,recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'& recr_age$d_512820379=='486306141'),]$d_821247024)
  #      
  #       197316935 219863910
  # 30-34        82         0
  # 35-39        91         0
  # 40-45       574         1
  # 46-50       518         0
  # 51-55       685         0
  # 56-60       708         0
  # 61-65       684         0
  # 66-70       193         0
table(recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'& recr_age$d_512820379=='854703046'),]$age,recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'& recr_age$d_512820379=='854703046'),]$d_821247024)
       
  #       197316935 219863910 922622075
  # 30-34         7         0         0
  # 35-39         7         0         0
  # 40-45        15         0         0
  # 46-50         9         0         0
  # 51-55         4         0         0
  # 56-60        22         0         0
  # 61-65        17         1         1
  # 66-70         1         0         0

#KPCO
age_kpco <- recr_age[which((recr_age$recru_time < '2024-05-02'| recr_age$verified_time < '2024-05-02') & recr_age$d_827220437 == '125001209'),]

table(recr_age[which(recr_age$recru_time < '2024-05-02' & recr_age$d_827220437 == '125001209'),]$age, recr_age[which(recr_age$recru_time < '2024-05-02' & recr_age$d_827220437 == '125001209'),]$d_512820379)
  #      
  #       486306141 854703046
  # 30-34      4418         2
  # 35-39      4903         9
  # 40-45     30943        39
  # 46-50     23310        28
  # 51-55     24329        35
  # 56-60     22097        21
  # 61-65     32493        39
  # 66-70      7813         4
table(recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '125001209'),]$age,recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '125001209'),]$d_821247024)
 #       
 #        160161595 197316935 219863910 922622075
 #  30-34         1       109         0         0
 #  35-39         0       200         0         0
 #  40-45         1      1047         1         0
 #  46-50         2       761         2         0
 #  51-55         1       850         0         0
 #  56-60         2       749         2         0
 #  61-65         0      1087         5         0
 #  66-70         1       431         0         0  
  table(recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '125001209'& recr_age$d_512820379=='486306141'),]$age,recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '125001209'& recr_age$d_512820379=='486306141'),]$d_821247024)
       
  #       160161595 197316935 219863910
  # 30-34         1       107         0
  # 35-39         0       191         0
  # 40-45         1      1009         1
  # 46-50         2       733         2
  # 51-55         1       815         0
  # 56-60         2       728         2
  # 61-65         0      1048         5
  # 66-70         1       428         0 
  
#KPGA  
kpga_age <- recr_age[which(recr_age$recru_time < '2024-04-29' & recr_age$d_827220437 == '452412599'),]  
  
table(recr_age[which(recr_age$recru_time < '2024-04-29' & recr_age$d_827220437 == '327912200'),]$age, recr_age[which(recr_age$recru_time < '2024-04-29' & recr_age$d_827220437 == '327912200'),]$d_512820379)
       
  #       486306141 854703046
  # 30-34       821         1
  # 35-39       985         4
  # 40-45     11981        13
  # 46-50     10941        13
  # 51-55     12886        23
  # 56-60     12347        18
  # 61-65     16348        16
  # 66-70      1376         8  
table(recr_age[which(recr_age$verified_time < '2024-04-29' & recr_age$d_827220437 == '327912200' & recr_age$d_821247024=='197316935'),]$age,recr_age[which(recr_age$verified_time < '2024-04-29' & recr_age$d_827220437 == '327912200'& recr_age$d_821247024=='197316935'),]$d_512820379)
       
  #       486306141 854703046
  # 30-34        21         1
  # 35-39        21         4
  # 40-45       304        13
  # 46-50       289        13
  # 51-55       336        23
  # 56-60       360        18
  # 61-65       458        15
  # 66-70        49         7


#KPHI  
kphi_age <- recr_age[which((recr_age$recru_time < '2024-04-22' | recr_age$verified_time < '2024-04-22') & recr_age$d_827220437 == '300267574'),]

table(recr_age[which(recr_age$verified_time < '2024-04-22' & recr_age$d_827220437 == '300267574'& recr_age$d_821247024=='197316935'),]$age,recr_age[which(recr_age$verified_time < '2024-04-22' & recr_age$d_827220437 == '300267574'& recr_age$d_821247024=='197316935'),]$d_512820379)
  #      
  #       486306141 854703046
  # 30-34        24         1
  # 35-39        48         1
  # 40-45       320        14
  # 46-50       235        18
  # 51-55       291        12
  # 56-60       289        15
  # 61-65       341        13
  # 66-70        92         2
 table(recr_age[which(recr_age$recru_time < '2024-04-22' & recr_age$d_827220437 == '300267574'& recr_age$d_512820379=='486306141'),]$age)
# 
# 30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
#  1415  1734 13945 10603 11051 11068 14196  2373 
 
#KPNW 
dim(recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '452412599'& recr_age$d_512820379=='486306141'),])
#[1] 151238     23
 table(recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '452412599'& recr_age$d_821247024=='197316935'),]$age)

# 30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
#   154   241  1257  1008   988   877  1294   349 
 table(recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '452412599'& recr_age$d_821247024=='197316935'),]$age,recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '452412599'& recr_age$d_821247024=='197316935'),]$d_512820379)
  #      
  #       486306141 854703046
  # 30-34       148         6
  # 35-39       238         3
  # 40-45      1220        37
  # 46-50       984        24
  # 51-55       964        24
  # 56-60       853        24
  # 61-65      1269        25
  # 66-70       346         3
table(recr_age[which(recr_age$recru_time < '2024-04-30' & recr_age$d_827220437 == '452412599'& recr_age$d_512820379=='486306141'),]$age)

# 30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70 
#  4997  5755 33327 24526 24472 22118 30180  5862  

age_hp <- recr_age[which((recr_age$recru_time < '2024-05-02') & recr_age$d_827220437 == '531629870'),]
age_sp <- recr_age[which((recr_age$recru_time < '2024-04-9') & recr_age$d_827220437 == '657167265'),]
age_uch <-recr_age[which((recr_age$recru_time < '2024-04-30' ) & recr_age$d_827220437 == '809703864'),]
age_mf <- recr_age[which((recr_age$recru_time < '2024-04-30')& recr_age$d_827220437 == '303349821'),]
age_hfh <- recr_age[which((recr_age$recru_time < '2024-05-03') & recr_age$d_827220437 == '548392715'),]
kpnw_age <- recr_age[which((recr_age$recru_time < '2024-04-30') & recr_age$d_827220437 == '452412599'),]
age_kpco <- recr_age[which((recr_age$recru_time < '2024-05-02') & recr_age$d_827220437 == '125001209'),]
kpga_age <- recr_age[which((recr_age$recru_time < '2024-04-29' )& recr_age$d_827220437 == '327912200'),]  
kphi_age <- recr_age[which((recr_age$recru_time < '2024-04-22' ) & recr_age$d_827220437 == '300267574'),]

all_age <- bind_rows(age_hfh,age_hp,age_mf,age_sp,age_uch,age_kpco,kpnw_age,kpga_age,kphi_age) %>% as_tibble()

 table(all_age$d_512820379,all_age$age)

age_hp_veri <- recr_age[which(recr_age$verified_time < '2024-05-02' & recr_age$d_827220437 == '531629870'),]
age_sp_veri <- recr_age[which( recr_age$verified_time < '2024-04-09' & recr_age$d_827220437 == '657167265'),]
age_uch_veri <-recr_age[which( recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '809703864'),]
age_mf_veri <- recr_age[which(recr_age$verified_time < '2024-04-30'& recr_age$d_827220437 == '303349821'),]
age_hfh_veri <- recr_age[which(recr_age$verified_time < '2024-05-03' & recr_age$d_827220437 == '548392715'),]
kpnw_age_veri <- recr_age[which(recr_age$verified_time < '2024-04-30' & recr_age$d_827220437 == '452412599'),]
age_kpco_veri <- recr_age[which((recr_age$verified_time < '2024-05-02') & recr_age$d_827220437 == '125001209'),]
kpga_age_veri <- recr_age[which(( recr_age$verified_time < '2024-04-29')& recr_age$d_827220437 == '327912200'),]  
kphi_age_veri <- recr_age[which(( recr_age$verified_time < '2024-04-22') & recr_age$d_827220437 == '300267574'),]

all_age_veri <- bind_rows(age_hfh_veri,age_hp_veri,age_mf_veri,age_sp_veri,age_uch_veri,age_kpco_veri,kpnw_age_veri,kpga_age_veri,kphi_age_veri) %>% as_tibble()

table(all_age_veri[!is.na(all_age_veri$age),]$d_821247024,all_age_veri[!is.na(all_age_veri$age),]$age)
  #          30-34 35-39 40-45 46-50 51-55 56-60 61-65 66-70
  # 160161595     1     2    15     6     4     2     1     1
  # 197316935   652   883  6236  5047  5725  5661  6649  1518
  # 219863910     0     0    15    11     7    11    16     4
  # 922622075     0     0     6     6     6    10    12     0
```
